---
title: 'Funcionamiento de las consultas: EF Core'
author: rowanmiller
ms.date: 10/27/2016
ms.assetid: de2e34cd-659b-4cab-b5ed-7a979c6bf120
uid: core/querying/overview
ms.openlocfilehash: f1c23471bfbc998b2d4f9dc579d1404d6202e109
ms.sourcegitcommit: dadee5905ada9ecdbae28363a682950383ce3e10
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 08/27/2018
ms.locfileid: "42993208"
---
# <a name="how-queries-work"></a><span data-ttu-id="6f0ce-102">Funcionamiento de las consultas</span><span class="sxs-lookup"><span data-stu-id="6f0ce-102">How Queries Work</span></span>

<span data-ttu-id="6f0ce-103">Entity Framework Core usa Language Integrated Query (LINQ) para consultar datos de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-103">Entity Framework Core uses Language Integrated Query (LINQ) to query data from the database.</span></span> <span data-ttu-id="6f0ce-104">LINQ permite usar C# (o el lenguaje .NET que prefiera) para escribir consultas fuertemente tipadas basadas en el contexto derivado y las clases de entidad.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-104">LINQ allows you to use C# (or your .NET language of choice) to write strongly typed queries based on your derived context and entity classes.</span></span>

## <a name="the-life-of-a-query"></a><span data-ttu-id="6f0ce-105">La duración de una consulta</span><span class="sxs-lookup"><span data-stu-id="6f0ce-105">The life of a query</span></span>

<span data-ttu-id="6f0ce-106">A continuación se muestra información general de alto nivel del proceso por el que pasa toda consulta.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-106">The following is a high level overview of the process each query goes through.</span></span>

1. <span data-ttu-id="6f0ce-107">Entity Framework Core procesa la consulta LINQ para crear una representación que está lista para que el proveedor de base de datos la procese.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-107">The LINQ query is processed by Entity Framework Core to build a representation that is ready to be processed by the database provider</span></span>
   1. <span data-ttu-id="6f0ce-108">El resultado se almacena en caché para que no sea necesario hacer este procesamiento cada vez que se ejecuta la consulta.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-108">The result is cached so that this processing does not need to be done every time the query is executed</span></span>
2. <span data-ttu-id="6f0ce-109">El resultado se pasa al proveedor de base de datos.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-109">The result is passed to the database provider</span></span>
   1. <span data-ttu-id="6f0ce-110">El proveedor de base de datos identifica qué partes de la consulta se pueden evaluar en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-110">The database provider identifies which parts of the query can be evaluated in the database</span></span>
   2. <span data-ttu-id="6f0ce-111">Estas partes de la consulta se traducen al lenguaje de la consulta específico para la base de datos (por ejemplo, SQL para una base de datos relacional).</span><span class="sxs-lookup"><span data-stu-id="6f0ce-111">These parts of the query are translated to database specific query language (for example, SQL for a relational database)</span></span>
   3. <span data-ttu-id="6f0ce-112">Una o varias consultas se envían a la base de datos y se devuelve el conjunto de resultados (los resultados son valores de la base de datos y no instancias de entidad).</span><span class="sxs-lookup"><span data-stu-id="6f0ce-112">One or more queries are sent to the database and the result set returned (results are values from the database, not entity instances)</span></span>
3. <span data-ttu-id="6f0ce-113">Para cada elemento del conjunto de resultados</span><span class="sxs-lookup"><span data-stu-id="6f0ce-113">For each item in the result set</span></span>
   1. <span data-ttu-id="6f0ce-114">Si se trata de una consulta con seguimiento, EF comprueba si los datos representan una entidad que ya existe en la herramienta de seguimiento de cambios para la instancia de contexto.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-114">If this is a tracking query, EF checks if the data represents an entity already in the change tracker for the context instance</span></span>
      * <span data-ttu-id="6f0ce-115">Si es así, se devuelve la entidad existente.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-115">If so, the existing entity is returned</span></span>
      * <span data-ttu-id="6f0ce-116">En caso contrario, se crea una entidad nueva, se configura el seguimiento de cambios y se devuelve la entidad nueva.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-116">If not, a new entity is created, change tracking is setup, and the new entity is returned</span></span>
   2. <span data-ttu-id="6f0ce-117">Si se trata de una consulta sin seguimiento, EF comprueba si los datos representan una entidad que ya existe en el conjunto de resultados de esta consulta.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-117">If this is a no-tracking query, EF checks if the data represents an entity already in the result set for this query</span></span>
      * <span data-ttu-id="6f0ce-118">Si es así, se devuelve la entidad existente <sup>(1)</sup>.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-118">If so, the existing entity is returned <sup>(1)</sup></span></span>
      * <span data-ttu-id="6f0ce-119">En caso contrario, se crea y devuelve una entidad nueva.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-119">If not, a new entity is created and returned</span></span>

<span data-ttu-id="6f0ce-120"><sup>(1)</sup> Las consultas sin seguimiento usan referencias parciales para llevar un seguimiento de las entidades que ya se devolvieron.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-120"><sup>(1)</sup> No tracking queries use weak references to keep track of entities that have already been returned.</span></span> <span data-ttu-id="6f0ce-121">Si un resultado anterior con la misma identidad queda fuera del ámbito y se ejecuta la recolección de elementos no utilizados, puede obtener una instancia de entidad nueva.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-121">If a previous result with the same identity goes out of scope, and garbage collection runs, you may get a new entity instance.</span></span>

## <a name="when-queries-are-executed"></a><span data-ttu-id="6f0ce-122">Cuándo se ejecutan las consultas</span><span class="sxs-lookup"><span data-stu-id="6f0ce-122">When queries are executed</span></span>

<span data-ttu-id="6f0ce-123">Cuando llama a los operadores LINQ, simplemente crea una representación de la consulta en memoria.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-123">When you call LINQ operators, you are simply building up an in-memory representation of the query.</span></span> <span data-ttu-id="6f0ce-124">La consulta solo se envía a la base de datos cuando se usan los resultados.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-124">The query is only sent to the database when the results are consumed.</span></span>

<span data-ttu-id="6f0ce-125">Las operaciones más comunes que generan que la consulta se envíe a la base de datos son:</span><span class="sxs-lookup"><span data-stu-id="6f0ce-125">The most common operations that result in the query being sent to the database are:</span></span>
* <span data-ttu-id="6f0ce-126">La iteración de los resultados en un bucle `for`</span><span class="sxs-lookup"><span data-stu-id="6f0ce-126">Iterating the results in a `for` loop</span></span>
* <span data-ttu-id="6f0ce-127">El uso de un operador como `ToList`, `ToArray`, `Single`, `Count`</span><span class="sxs-lookup"><span data-stu-id="6f0ce-127">Using an operator such as `ToList`, `ToArray`, `Single`, `Count`</span></span>
* <span data-ttu-id="6f0ce-128">El enlace de datos de los resultados de una consulta a una interfaz de usuario</span><span class="sxs-lookup"><span data-stu-id="6f0ce-128">Databinding the results of a query to a UI</span></span>

> [!WARNING]  
> <span data-ttu-id="6f0ce-129">**Valide siempre la intervención del usuario:** si bien EF brinda protección contra ataques por inyección de código SQL, no realiza ninguna validación general de la intervención.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-129">**Always validate user input:** While EF does provide protection from SQL injection attacks, it does not do any general validation of input.</span></span> <span data-ttu-id="6f0ce-130">Por tanto, si los valores que se pasan a las API, que se usan en las consultas LINQ, que están asignadas a las propiedades de entidad, etc., provienen de un origen que no es de confianza, se debe realizar la validación correspondiente según los requisitos de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-130">Therefore if values being passed to APIs, used in LINQ queries, assigned to entity properties, etc., come from an untrusted source then appropriate validation, per your application requirements, should be performed.</span></span> <span data-ttu-id="6f0ce-131">Esto incluye cualquier intervención del usuario que se use para construir consultas de manera dinámica.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-131">This includes any user input used to dynamically construct queries.</span></span> <span data-ttu-id="6f0ce-132">Incluso al usar LINQ, si acepta la intervención del usuario para crear expresiones, necesita garantizar que solo se pueden construir las expresiones previstas.</span><span class="sxs-lookup"><span data-stu-id="6f0ce-132">Even when using LINQ, if you are accepting user input to build expressions you need to make sure than only intended expressions can be constructed.</span></span>
